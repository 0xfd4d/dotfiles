#!/bin/bash

LEMONBAR_FIFO="/tmp/lemonbar_fifo"

[ -e "$LEMONBAR_FIFO" ] && rm "$LEMONBAR_FIFO"
mkfifo "$LEMONBAR_FIFO"

C1="$(xrdb -query | grep color0: | awk '{print $2}')"
C2="$(xrdb -query | grep color7: | awk '{print $2}')"
C3="$(xrdb -query | grep color4: | awk '{print $2}')"

C="%{B$C2}%{F$C1}"
CU="%{B$C3}%{F$C2}"


R="%{B-}%{F-}"

desktops() {
    while true; do
        bspc subscribe | \
        while read -r line; do
            [ $( echo $line | grep "^WM$MONITOR" ) ] || continue
            desktops=""
            for e in $(echo $line | cut -d':' -f2-10 | tr ':' '\n'); do
                desktop=""
                if [ "${e:0:1}" = "O" ]; then
                    desktop="$C ${e:1} $R "
                elif [ "${e:0:1}" = "o" ]; then
                    desktop="${e:1} "
                elif [ "${e:0:1}" == "F" ]; then
                    desktop="$C ${e:1} $R "
                elif [ "${e:0:1}" == "u" ]; then
                    desktop="$CU${e:1}$R "
                fi
                desktops="$desktops$desktop"
            done
            sleep 0.025
            echo "D$desktops"
        done
    done
}

title() {
    sleep 1
    xtitle -s | \
    while read -r title; do
        sleep 0.025
        if [ "$title" != "" ]; then
            echo "T $C ${title:0:80} $R"
        else
            echo "T"
        fi
    done
}

dateTime() {
    while true; do
        DATE=$(date '+%H:%M %a %d %b')
        echo "C $C $DATE $R"
        sleep 15
    done
}

printSong() {
    STATUS_1=$(mpc current 2> /dev/null)
    if [ "$STATUS_1" != "" ]; then
        STATUS_2=$(mpc | sed -n '2p')
        if [[ $STATUS_2 == *"paused"* ]]
        then
            echo "M"
        else
            echo "M $C $STATUS_1 $R"
        fi
    else
        echo "M"
    fi
}

music() {
  while true; do
      sleep 1
      echo $(printSong)
      mpc idleloop 2> /dev/null | \
          while read -r line; do
              echo $(printSong)
          done
      sleep 5
  done
}

wifi() {
    while true; do
        IW=$(/usr/sbin/iw wlp6s0 link)
        WIFI_SSID=$(echo "$IW" | grep 'SSID' | sed 's/SSID: //' | sed 's/\t//')
        if [ "$WIFI_SSID" != "" ]; then
            WIFI_SIGNAL=$(echo "$IW" | grep 'signal' | sed 's/signal: //' | sed 's/ dBm//' | sed 's/\t//')
            echo "W ${C} wifi: $WIFI_SSID $WIFI_SIGNAL $R"
        else
            echo "W"
        fi
        sleep 10
    done
}

compose() {
    while read -r line; do
        case $line in
            D*)
                desktop="${line#?}"
                ;;
            T*)
                title="${line#?}"
                ;;
            M*)
                music="${line#?}"
                ;;
            W*)
                wifi="${line#?}"
                ;;
            C*)
                clock="${line#?}"
                ;;
        esac
        echo "${desktop}${title}${clock}${wifi}${music} %{r}${CU}TODO: галерея$R"
    done
}

desktops    > "$LEMONBAR_FIFO" &
title       > "$LEMONBAR_FIFO" &
music       > "$LEMONBAR_FIFO" &
wifi        > "$LEMONBAR_FIFO" &
dateTime    > "$LEMONBAR_FIFO" &

cat "$LEMONBAR_FIFO" | compose | lemonbar -g "1365x13+0+0" -o 1 -B "$C1" -F "$C2" -f "-*-fixed-medium-r-*-*-13-*-*-*-*-*-iso10646-*" LVDS-0
